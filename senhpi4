#!/bin/bash
# sudo wget --inet4-only -O- https://raw.githubusercontent.com/CarloseOldenburg/senhapi4/refs/heads/main/senhpi4.sh | bash

# === CONFIGURAÃ‡ÃƒO ===
JDK_URL="https://painel-sga-cdn.s3.us-east-2.amazonaws.com/jdk-23_linux-aarch64_bin.tar.gz"
JAVAFX_URL="https://painel-sga-cdn.s3.us-east-2.amazonaws.com/openjfx-23.0.2_linux-aarch64_bin-sdk.zip"
PAINEL_URL="https://painel-sga-cdn.s3.us-east-2.amazonaws.com/painel-sga.zip"
USER_HOME="/home/pi"

echo "ðŸ“¦ Atualizando fontes para Bookworm..."
sudo sed -i 's/bullseye/bookworm/g' /etc/apt/sources.list

echo "ðŸ“¦ Atualizando o sistema..."
sudo apt update && sudo apt full-upgrade -y

echo "ðŸ“¦ Instalando bibliotecas necessÃ¡rias..."
sudo apt install -y libgtk-3-dev libgl1-mesa-glx unzip wget

echo "ðŸ“¥ Baixando e extraindo JDK..."
wget -O /tmp/jdk.tar.gz "$JDK_URL"
sudo tar -xzf /tmp/jdk.tar.gz -C /opt
sudo rm /tmp/jdk.tar.gz

echo "ðŸ“¥ Baixando e extraindo JavaFX..."
wget -O /tmp/javafx.zip "$JAVAFX_URL"
unzip -q /tmp/javafx.zip -d "$USER_HOME"
rm /tmp/javafx.zip

echo "ðŸ“¥ Baixando e extraindo Painel SGA..."
wget -O /tmp/painel-sga.zip "$PAINEL_URL"
unzip -q /tmp/painel-sga.zip -d "$USER_HOME"
rm /tmp/painel-sga.zip

echo "âš™ï¸  Configurando o JDK 23 como padrÃ£o..."
sudo update-alternatives --install /usr/bin/java java /opt/jdk-23.0.2/bin/java 1
sudo update-alternatives --install /usr/bin/javac javac /opt/jdk-23.0.2/bin/javac 1

echo "ðŸ“ Configurando execuÃ§Ã£o automÃ¡tica no ~/.bashrc..."
BASHRC="$USER_HOME/.bashrc"
JAVA_CMD="java -Djava.library.path=$USER_HOME/javafx-sdk-23.0.2/lib \
--module-path $USER_HOME/javafx-sdk-23.0.2/lib \
--add-modules javafx.controls,javafx.fxml,javafx.web,javafx.swing,javafx.media \
-jar $USER_HOME/painel-sga-1.0-SNAPSHOT.jar"

# Adiciona ao bashrc apenas se ainda nÃ£o existir
grep -qxF "$JAVA_CMD" "$BASHRC" || echo "$JAVA_CMD" >> "$BASHRC"

echo "âœ… InstalaÃ§Ã£o finalizada com sucesso!"
echo "âž¡ Reinicie o Raspberry Pi ou abra um novo terminal para executar o painel automaticamente."
